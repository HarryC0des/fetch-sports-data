<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NBA Newsletter Signup</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 24px;
            color: #1f2937;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .card {
            background: #ffffff;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 16px 40px rgba(15, 23, 42, 0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 28px;
        }

        .header h1 {
            font-size: 2.2rem;
            color: #0f172a;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1rem;
            color: #475569;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        label {
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 6px;
            display: block;
        }

        .field-group {
            display: flex;
            flex-direction: column;
        }

        input[type="text"],
        input[type="email"],
        select {
            padding: 12px 14px;
            border: 1px solid #cbd5f5;
            border-radius: 10px;
            font-size: 1rem;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15);
        }

        .helper {
            font-size: 0.9rem;
            color: #64748b;
            margin-top: 4px;
        }

        .error-text {
            font-size: 0.9rem;
            color: #dc2626;
            margin-top: 6px;
            display: none;
        }

        .error-text.show {
            display: block;
        }

        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px 16px;
            margin-top: 8px;
        }

        .team-option {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .submit-btn {
            background: #1d4ed8;
            color: #ffffff;
            padding: 14px 20px;
            border: none;
            border-radius: 999px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            align-self: center;
            min-width: 200px;
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
        }

        .submit-btn:not(:disabled):hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(29, 78, 216, 0.25);
        }

        .status {
            padding: 12px 14px;
            border-radius: 10px;
            font-size: 0.95rem;
            display: none;
        }

        .status.success {
            background: #dcfce7;
            color: #166534;
        }

        .status.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .status.show {
            display: block;
        }

        @media (max-width: 600px) {
            body {
                padding: 16px;
            }

            .card {
                padding: 24px;
            }

            .submit-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="header">
                <h1>NBA Newsletter Signup</h1>
                <p>Get daily or weekly NBA takes customized to your favorite teams.</p>
            </div>

            <form id="signupForm" novalidate>
                <div class="field-group">
                    <label for="name">Name</label>
                    <input id="name" name="name" type="text" required>
                    <div class="error-text" id="error-name"></div>
                </div>

                <div class="field-group">
                    <label for="email">Email address</label>
                    <input id="email" name="email" type="email" required>
                    <div class="error-text" id="error-email"></div>
                </div>

                <div class="field-group">
                    <label>NBA Teams (max {{ max_teams }})</label>
                    <div class="helper" id="teamCount">0 selected</div>
                    <div class="team-grid" id="teamGrid">
                        {% for team in teams %}
                        <label class="team-option">
                            <input type="checkbox" name="teams" value="{{ team }}">
                            <span>{{ team }}</span>
                        </label>
                        {% endfor %}
                    </div>
                    <div class="error-text" id="error-teams"></div>
                </div>

                <div class="field-group">
                    <label for="style">Newsletter style</label>
                    <select id="style" name="style" required>
                        <option value="">Select a style</option>
                        {% for style in styles %}
                        <option value="{{ style.value }}">{{ style.label }}</option>
                        {% endfor %}
                    </select>
                    <div class="error-text" id="error-style"></div>
                </div>

                <div class="field-group">
                    <label>Email frequency</label>
                    <div class="radio-group">
                        {% for frequency in frequencies %}
                        <label class="radio-option">
                            <input type="radio" name="frequency" value="{{ frequency }}">
                            <span>{{ frequency|capitalize }}</span>
                        </label>
                        {% endfor %}
                    </div>
                    <div class="error-text" id="error-frequency"></div>
                </div>

                <div class="status success" id="successMsg" role="status" aria-live="polite"></div>
                <div class="status error" id="errorMsg" role="alert"></div>

                <button class="submit-btn" id="submitBtn" type="submit" disabled>Sign up</button>
            </form>
        </div>
    </div>

    <script>
        const maxTeams = {{ max_teams }};
        const form = document.getElementById('signupForm');
        const submitBtn = document.getElementById('submitBtn');
        const teamCheckboxes = Array.from(document.querySelectorAll('input[name="teams"]'));
        const teamCount = document.getElementById('teamCount');
        const successMsg = document.getElementById('successMsg');
        const errorMsg = document.getElementById('errorMsg');

        function showFieldError(field, message) {
            const el = document.getElementById(`error-${field}`);
            if (!el) return;
            el.textContent = message || '';
            el.classList.toggle('show', Boolean(message));
        }

        function setStatus(type, message) {
            successMsg.classList.remove('show');
            errorMsg.classList.remove('show');
            if (!message) return;
            const target = type === 'success' ? successMsg : errorMsg;
            target.textContent = message;
            target.classList.add('show');
        }

        function validateEmail(email) {
            return /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email);
        }

        function updateTeamState(changed) {
            const selected = teamCheckboxes.filter(cb => cb.checked).map(cb => cb.value);
            if (selected.length > maxTeams && changed) {
                changed.checked = false;
            }
            const count = teamCheckboxes.filter(cb => cb.checked).length;
            teamCount.textContent = `${count} selected`;
            teamCheckboxes.forEach(cb => {
                cb.disabled = !cb.checked && count >= maxTeams;
            });
            if (count === 0) {
                showFieldError('teams', 'Select at least one team.');
            } else if (count > maxTeams) {
                showFieldError('teams', `Select up to ${maxTeams} teams.`);
            } else {
                showFieldError('teams', '');
            }
            return count > 0 && count <= maxTeams;
        }

        function validateForm() {
            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const style = document.getElementById('style').value;
            const frequency = form.querySelector('input[name="frequency"]:checked');

            showFieldError('name', name ? '' : 'Name is required.');
            showFieldError('email', validateEmail(email) ? '' : 'Enter a valid email address.');
            showFieldError('style', style ? '' : 'Select a style.');
            showFieldError('frequency', frequency ? '' : 'Select a frequency.');

            const teamsValid = updateTeamState();
            const isValid = Boolean(name)
                && validateEmail(email)
                && teamsValid
                && Boolean(style)
                && Boolean(frequency);
            submitBtn.disabled = !isValid;
            return isValid;
        }

        teamCheckboxes.forEach(cb => {
            cb.addEventListener('change', event => {
                updateTeamState(event.target);
                validateForm();
            });
        });

        document.getElementById('name').addEventListener('input', validateForm);
        document.getElementById('email').addEventListener('input', validateForm);
        document.getElementById('style').addEventListener('change', validateForm);
        form.querySelectorAll('input[name="frequency"]').forEach(radio => {
            radio.addEventListener('change', validateForm);
        });

        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            setStatus('', '');
            if (!validateForm()) {
                return;
            }
            submitBtn.disabled = true;

            const payload = {
                name: document.getElementById('name').value.trim(),
                email: document.getElementById('email').value.trim(),
                teams: teamCheckboxes.filter(cb => cb.checked).map(cb => cb.value),
                style: document.getElementById('style').value,
                frequency: form.querySelector('input[name="frequency"]:checked').value
            };

            try {
                const response = await fetch('/api/signup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                if (!response.ok || !data.success) {
                    if (data.errors) {
                        Object.entries(data.errors).forEach(([field, message]) => {
                            showFieldError(field, message);
                        });
                    }
                    throw new Error(data.error || 'Signup failed.');
                }
                setStatus('success', 'Thanks! Your preferences have been saved.');
                form.reset();
                updateTeamState();
            } catch (error) {
                setStatus('error', error.message);
            } finally {
                validateForm();
            }
        });

        validateForm();
    </script>
</body>
</html>
